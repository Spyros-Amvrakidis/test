name: Keycode webhook test

on:
  workflow_dispatch:

jobs:
  call-webhook:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Connect to Tailscale (OAuth version)
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }} 
          oauth-secret:    ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags:            tag:github-actions-keycode
          ping:            vavelio-reverse-proxy-private.gate-cordylus.ts.net
          version:         latest

      - name: Show Tailscale self IP
        run: |
          tailscale ip -4 || true
          tailscale status || true

      - name: Call Vavel webhook (GET)
        id: webhook
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --location 'https://automations.vavel.cloud/webhook-test/9c024f92-6d54-40b5-8cf8-5dc07fe3c7b2' \
            --header "Vavel-Auth: ${{ secrets.API_CALL_TOKEN }}" \
            --header "Content-Type: text/plain")
          echo "http_status=$response" >> $GITHUB_OUTPUT

      - name: Check webhook call succeeded
        if: steps.webhook.outputs.http_status == '200'
        run: |
          echo "✅ Webhook responded with 200 OK"

      - name: Fail if webhook call failed
        if: steps.webhook.outputs.http_status != '200'
        run: |
          echo "::error webhook call failed, status code=${{ steps.webhook.outputs.http_status }}"
          exit 1

      # (Optional) tailscale logout — the action auto-cleans ephemeral node, so not strictly required
      - name: Disconnect Tailscale
        if: always()
        run: tailscale logout || true